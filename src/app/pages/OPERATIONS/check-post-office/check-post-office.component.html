<div class="view-wrapper list-page">
  <div class="formData" [ngClass]="{ 'hide-content': !isContentVisible }">
    <dx-form>
      <dxi-item
        itemType="group"
        cssClass="form-group"
        class="rowGroup"
        [colCount]="10"
        [colCountByScreen]="{ xs: 10, sm: 10, md: 10, lg: 10 }"
      >
        <dxi-item [colSpan]="8">
          <dx-drop-down-box
            #facilityDropDown
            labelMode="floating"
            labelLocation="left"
            label="Select Facility"
            [(value)]="Facility_Value"
            valueExpr="ID"
            displayExpr="FacilityName"
            [showClearButton]="true"
            [dataSource]="Facility_DataSource"
          >
            <div *dxTemplate="let data of 'content'">
              <dx-data-grid
                [dataSource]="Facility_DataSource"
                [columns]="[
                  { dataField: 'FacilityLicense', caption: 'License' },
                  { dataField: 'FacilityName', caption: 'Name' },
                  { dataField: 'FacilityGroup', caption: 'Group' },
                  { dataField: 'PostOffice', caption: 'Post Office' }
                ]"
                keyExpr="ID"
                [columnAutoWidth]="true"
                [selection]="{ mode: 'single' }"
                [hoverStateEnabled]="true"
                [paging]="{ enabled: true, pageSize: 10 }"
                [filterRow]="{ visible: true }"
                [headerFilter]="{ visible: true }"
                [scrolling]="{ mode: 'virtual' }"
                [height]="250"
                [(selectedRowKeys)]="Facility_Value"
                (onSelectionChanged)="onFacilitySelected($event)"
              >
              </dx-data-grid>
            </div>
          </dx-drop-down-box>
        </dxi-item>

        <dxi-item [colSpan]="2">
          <div>
            <dx-select-box
              labelMode="floating"
              labelLocation="left"
              label="Mode"
              [dataSource]="FileModeDataSource"
              displayExpr="Description"
              valueExpr="ID"
              [(value)]="modeValue"
              [searchEnabled]="true"
            >
            </dx-select-box>
          </div>
        </dxi-item>
      </dxi-item>

      <dxi-item
        itemType="group"
        cssClass="form-group"
        [colCount]="10"
        [colCountByScreen]="{ xs: 10, sm: 10, md: 10, lg: 10 }"
      >
        <dxi-item [colSpan]="2">
          <dx-date-box
            labelMode="floating"
            labelLocation="left"
            label="From Date"
            type="date"
            displayFormat="dd/MM/yyyy"
            valueFormat="yyyy/MM/dd"
            [(value)]="From_Date_Value"
            [min]="minDate"
            [max]="maxDate"
            (onValueChanged)="onFromDateChanged($event)"
          >
          </dx-date-box>
        </dxi-item>

        <dxi-item [colSpan]="2">
          <dx-date-box
            labelMode="floating"
            labelLocation="left"
            label="To Date"
            type="date"
            displayFormat="dd/MM/yyyy"
            valueFormat="yyyy/MM/dd"
            [(value)]="To_Date_Value"
            [min]="From_Date_Value"
            [max]="ToDateMax"
            (onValueChanged)="onToDateChanged($event)"
          >
          </dx-date-box>
        </dxi-item>

        <dxi-item [colSpan]="3">
          <div>
            <dx-select-box
              labelMode="floating"
              labelLocation="left"
              label="Transaction Type"
              [dataSource]="TransactionTypeDatasource"
              displayExpr="Description"
              valueExpr="ID"
              [(value)]="TransactionTypeValue"
              [searchEnabled]="true"
            >
            </dx-select-box>
          </div>
        </dxi-item>

        <dxi-item [colSpan]="3">
          <div>
            <dx-select-box
              labelMode="floating"
              labelLocation="left"
              label="File Status"
              [dataSource]="FileStatusDataSorce"
              displayExpr="Description"
              valueExpr="ID"
              [(value)]="FileStatusValue"
              [searchEnabled]="true"
            >
            </dx-select-box>
          </div>
        </dxi-item>
      </dxi-item>

      <dxi-item
        itemType="group"
        cssClass="form-group"
        [colCount]="8"
        [colCountByScreen]="{ xs: 8, sm: 8, md: 8, lg: 8 }"
      >
        <dxi-item [colSpan]="3">
          <dx-text-box
            label="Transaction ID"
            labelMode="floating"
            labelLocation="left"
            [(value)]="TransactionID"
          >
          </dx-text-box>
        </dxi-item>

        <dxi-item [colSpan]="3">
          <dx-text-box
            labelMode="floating"
            labelLocation="left"
            label="Claim Number"
            [(value)]="ClaimNumberValue"
          >
          </dx-text-box>
        </dxi-item>

        <dxi-item [colSpan]="2" cssClass="align-right">
          <dx-button
            icon="search"
            text="Search"
            type="default"
            stylingMode="contained"
            (onClick)="get_Datagrid_DataSource()"
          ></dx-button>
        </dxi-item>
      </dxi-item>
    </dx-form>
  </div>

  <div class="button-container mt-1 mb-2">
    <dx-button
      class="toggleButton"
      icon="{{ isContentVisible ? 'chevronup' : 'chevrondown' }}"
      stylingMode="outlined"
      type="normal"
      [hint]="isContentVisible ? 'Hide Filter Contend' : 'Show Filter Contend'"
      [width]="200"
      [height]="13"
      (onClick)="toggleContent()"
    >
    </dx-button>
  </div>

  <div class="GridDataTable">
    <dx-data-grid
      class="grid theme-dependent"
      noDataText="No Data"
      [height]="isContentVisible ? '65vh' : '84vh'"
      [dataSource]="gridDataSource"
      [showBorders]="true"
      [allowColumnResizing]="true"
      [allowColumnReordering]="true"
      [rowAlternationEnabled]="true"
      rowAlternationInterval="2"
      [columnAutoWidth]="true"
    >
      <dxo-paging [pageSize]="10"></dxo-paging>
      <dxo-pager
        [visible]="true"
        [allowedPageSizes]="allowedPageSizes"
        [displayMode]="displayMode"
        [showPageSizeSelector]="showPageSizeSelector"
        [showInfo]="true"
        [showNavigationButtons]="true"
      ></dxo-pager>

      <dxo-load-panel [showPane]="false"></dxo-load-panel>
      <dxo-scrolling mode="virtual"></dxo-scrolling>
      <dxo-sorting mode="multiple"></dxo-sorting>
      <dxo-header-filter [visible]="true"></dxo-header-filter>
      <dxo-filter-row [visible]="isFilterRowVisible"></dxo-filter-row>
      <dxo-search-panel
        [visible]="true"
        placeholder=" Search"
      ></dxo-search-panel>
      <dxo-toolbar>
        <dxi-item location="before">
          <div class="grid-header">Download from Facility</div>
        </dxi-item>

        <dxi-item
          location="after"
          locateInMenu="auto"
          showText="inMenu"
          widget="dxButton"
          [options]="{
            icon: isFilterRowVisible ? 'filter' : 'filter',
            hint: isFilterRowVisible ? 'Hide Filter Row' : 'Show Filter Row',
            onClick: toggleFilterRow,
            stylingMode: 'text',
            elementAttr: { class: 'commonButtons' }
          }"
        ></dxi-item>
        <dxi-item
          location="after"
          locateInMenu="auto"
          showText="inMenu"
          widget="dxButton"
          [options]="{
            text: 'Refresh',
            icon: 'refresh',
            onClick: refresh,
            stylingMode: 'text'
          }"
        ></dxi-item>
      </dxo-toolbar>

      <dxo-header-filter [visible]="true">
        <dxo-search [enabled]="true"></dxo-search>
      </dxo-header-filter>

      <!-- Action Button Column -->
      <dxi-column
        *ngIf="gridDataSource"
        type="buttons"
        [width]="40"
        [fixed]="true"
        fixedPosition="left"
        [allowFixing]="false"
        [allowHiding]="false"
        [allowResizing]="false"
        [allowReordering]="false"
      >
        <dxi-button
          icon="detailslayout"
          text="Details"
          hint="View Details"
          [onClick]="openDetailsPopup"
        ></dxi-button>
      </dxi-column>

      <!-- Data Columns -->
      <dxi-column
        dataField="FileName"
        caption="File Name"
        [width]="200"
      ></dxi-column>
      <dxi-column
        dataField="TransactionType"
        caption="Transaction Type"
        [width]="200"
      ></dxi-column>
      <dxi-column
        dataField="SenderID"
        caption="Sender ID"
        [width]="200"
      ></dxi-column>
      <dxi-column
        dataField="ReceiverID"
        caption="Receiver ID"
        [width]="200"
      ></dxi-column>
      <dxi-column
        dataField="TransactionDate"
        caption="Transaction Date"
        [width]="200"
      ></dxi-column>
      <dxi-column
        dataField="RecordCount"
        caption="Record Count"
        dataType="number"
        [width]="'auto'"
      ></dxi-column>
      <dxi-column
        dataField="IsDownloaded"
        caption="Downloaded"
        [width]="'auto'"
      ></dxi-column>
    </dx-data-grid>
  </div>
  <dx-load-panel
    #loadPanel
    class="loadPanel"
    shadingColor="rgba(0,0,0,0)"
    [(visible)]="loadingVisible"
    [showIndicator]="true"
    [showPane]="false"
    [shading]="true"
    [hideOnOutsideClick]="false"
    [message]="'Loading...'"
    [position]="{ of: '.view-wrapper', at: 'center', my: 'center' }"
  >
  </dx-load-panel>
</div>
<!-- Details Popup -->
<dx-popup
  [(visible)]="popupVisible"
  [width]="'75%'"
  [height]="'80vh'"
  [showTitle]="true"
  title="File Details"
  [dragEnabled]="true"
  [closeOnOutsideClick]="false"
>
  <div
    *dxTemplate="let data of 'content'"
    style="overflow-y: auto; height: 100%; padding: 16px"
  >
    <div
      style="
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
      "
    >
      <div *ngFor="let item of headerFields">
        <dx-text-box
          [value]="item.value"
          [readOnly]="true"
          [placeholder]="item.label"
          stylingMode="outlined"
          labelMode="floating"
          [label]="item.label"
        ></dx-text-box>
      </div>
    </div>
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      "
    >
      <h5 style="margin: 0">XML Content</h5>
      <dx-button
        text="Download"
        icon="download"
        stylingMode="contained"
        type="default"
        (onClick)="downloadXmlFile()"
      ></dx-button>
    </div>
    <dx-text-area
      [value]="formattedXml"
      height="380"
      [readOnly]="true"
      stylingMode="outlined"
    ></dx-text-area>
  </div>
</dx-popup>
